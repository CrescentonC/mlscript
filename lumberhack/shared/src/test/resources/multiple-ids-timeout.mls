:NewParser
:ParseOnly

// WRONG: will timeout
// fun id(x) = x
// fun id1(y) = y
// fun id2(z) = z
// id2(if primitive then id1(id(id(id2)))(3) else id1(id(id(id2)))(4))

// CORRECT: will not timeout
fun id(x) = x
fun id1(y) = y
fun id2(z) = z
fun id3(z) = z
fun id4(z) = z
fun id5(z) = z
fun id6(z) = z
fun id7(z) = z
fun id8(z) = z
id(if primitive then id1(id2(id3(id4)))(3) else id5(id6(id7(id8)))(4))
//│ |#fun| |id|(|x|)| |#=| |x|↵|#fun| |id1|(|y|)| |#=| |y|↵|#fun| |id2|(|z|)| |#=| |z|↵|#fun| |id3|(|z|)| |#=| |z|↵|#fun| |id4|(|z|)| |#=| |z|↵|#fun| |id5|(|z|)| |#=| |z|↵|#fun| |id6|(|z|)| |#=| |z|↵|#fun| |id7|(|z|)| |#=| |z|↵|#fun| |id8|(|z|)| |#=| |z|↵|id|(|#if| |primitive| |#then| |id1|(|id2|(|id3|(|id4|)|)|)|(|3|)| |#else| |id5|(|id6|(|id7|(|id8|)|)|)|(|4|)|)|
//│ Parsed: {fun id = x, => x; fun id1 = y, => y; fun id2 = z, => z; fun id3 = z, => z; fun id4 = z, => z; fun id5 = z, => z; fun id6 = z, => z; fun id7 = z, => z; fun id8 = z, => z; id (if (primitive) then id1 (id2 (id3 (id4,),),) (3,) else id5 (id6 (id7 (id8,),),) (4,),)}
//│ >>>>>>>>>> Original >>>>>>>>>>
//│ id^19(if primitive⁰ then id1^21(id2^22(id3^23(id4^24)), 3) else id5^30(id6^31(id7^32(id8^33)), 4))
//│ def id(x⁰) = x⁰
//│ def id1(y⁰) = y⁰
//│ def id2(z⁰) = z⁰
//│ def id3(z¹) = z¹
//│ def id4(z²) = z²
//│ def id5(z³) = z³
//│ def id6(z⁴) = z⁴
//│ def id7(z⁵) = z⁵
//│ def id8(z⁶) = z⁶
//│ <<<<<<<<<< Original <<<<<<<<<<
//│ 
//│ >>>>>>> fusion matches >>>>>>>
//│ 
//│ ------------------
//│ 
//│ <<<<<<< fusion matches <<<<<<<
//│ 
//│ >>>>>>> new fusion strategy >>>>>>>
//│ 
//│ ------------------
//│ 
//│ <<<<<<< new fusion strategy <<<<<<<
//│ 
//│ >>>>>>> after fusion >>>>>>>
//│ id(if primitive⁰ then id1(id2(id3(id4)), 3) else id5(id6(id7(id8)), 4))
//│ def id(x¹) = x¹
//│ def id1(y¹) = y¹
//│ def id2(z¹⁰) = z¹⁰
//│ def id3(z¹³) = z¹³
//│ def id4(z⁸) = z⁸
//│ def id5(z⁹) = z⁹
//│ def id6(z¹²) = z¹²
//│ def id7(z⁷) = z⁷
//│ def id8(z¹¹) = z¹¹
//│ <<<<<<< after fusion <<<<<<<
//│ 
//│ >>>>>>> consumer ids >>>>>>>
//│ 
//│ <<<<<<< consumer ids <<<<<<<
//│ 
//│ >>>>>>> floating out info >>>>>>>
//│ 
//│ <<<<<<< floating out info <<<<<<<
//│ 
//│ >>>>>>> after inlining >>>>>>>
//│ id(if primitive⁰ then id1(id2(id3(id4)), 3) else id5(id6(id7(id8)), 4))
//│ def id(x⁰) = x⁰
//│ def id1(y⁰) = y⁰
//│ def id2(z³) = z³
//│ def id3(z⁶) = z⁶
//│ def id4(z¹) = z¹
//│ def id5(z²) = z²
//│ def id6(z⁵) = z⁵
//│ def id7(z⁰) = z⁰
//│ def id8(z⁴) = z⁴
//│ <<<<<<< after inlining <<<<<<<
//│ 
//│ >>>>>>> after floating out >>>>>>>
//│ id(if primitive⁰ then id1(id2(id3(id4)), 3) else id5(id6(id7(id8)), 4))
//│ def id(x⁰) = x⁰
//│ def id1(y⁰) = y⁰
//│ def id2(z³) = z³
//│ def id3(z⁶) = z⁶
//│ def id4(z¹) = z¹
//│ def id5(z²) = z²
//│ def id6(z⁵) = z⁵
//│ def id7(z⁰) = z⁰
//│ def id8(z⁴) = z⁴
//│ <<<<<<< after floating out <<<<<<<


// WRONG: will timeout sometimes
// fun id(x) = x
// fun id1(y) = y
// id1(id1(id1(id(id(id(id(id(id1)))))(3))))
